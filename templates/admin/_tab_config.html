<div class="container-fluid">

  <h4 class="mb-3">Application Settings</h4>

  <!-- ========================================================= -->
  <!-- Home Depot Configuration -->
  <!-- ========================================================= -->
  <div class="card mb-3 border-2 border-primary-subtle">
    <div class="card-header bg-primary text-white">
      Home Depot Configuration
    </div>
    <div class="card-body">

      {% if app_config and app_config.home_location %}
        <p class="small text-muted mb-2">
          Current home depot:
          <strong>
            {{ app_config.home_location.name }} [{{ app_config.home_location.code }}]
          </strong>
          {% if app_config.home_authority %}
            <br>
            Home authority:
            <strong>{{ app_config.home_authority.authority_title }}</strong>
            {% if app_config.home_authority.address %}
              – {{ app_config.home_authority.address }}
            {% endif %}
          {% endif %}
        </p>
      {% else %}
        <p class="small text-muted mb-2">
          Home depot is not configured yet. Set it below to enable home-based booking helpers.
        </p>
      {% endif %}

      <form
        method="POST"
        action="{{ url_for('admin.save_app_config') }}"
        class="row g-3"
      >
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

        <!-- Home depot location -->
        <div class="col-md-6">
          <label for="configHomeLocationInput" class="form-label">
            Home Depot Location
          </label>
          <input
            type="text"
            class="form-control"
            id="configHomeLocationInput"
            name="home_location_input"
            list="configHomeLocationList"
            placeholder="Type name or code, e.g. Erode Jn [ED]"
            value="{% if app_config and app_config.home_location %}{{ app_config.home_location.name }} [{{ app_config.home_location.code }}]{% endif %}"
            required
          >
          <div class="form-text">
            Start typing station name or code; choose from the suggestions.
          </div>
        </div>

        <!-- Home depot authority (optional) -->
        <div class="col-md-6">
          <label for="configHomeAuthoritySelect" class="form-label">
            Home Depot Authority (optional)
          </label>
          <select
            class="form-select"
            id="configHomeAuthoritySelect"
            name="home_authority_id"
          >
            <option value="">-- None / Not set --</option>
            {% for a in authorities %}
              <option
                value="{{ a.id }}"
                {% if app_config and app_config.home_authority_id == a.id %}selected{% endif %}
              >
                {{ a.authority_title }}
                {% if a.location %}
                  – {{ a.location.name }} [{{ a.location.code }}]
                {% endif %}
              </option>
            {% endfor %}
          </select>
          <div class="form-text">
            You can optionally select a default authority at the home depot.
          </div>
        </div>

        <div class="col-12 text-end">
          <button type="submit" class="btn btn-primary">
            Save Settings
          </button>
        </div>
      </form>
    </div>
  </div>


  <!-- ========================================================= -->
  <!-- Letter Signatory Master -->
  <!-- ========================================================= -->
  <div class="card mb-3 border-2 border-secondary-subtle">
    <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
      <span>Letter Signatory Master</span>
      <span class="small opacity-75">Used in Placement Advice: Name + Designation</span>
    </div>

    <div class="card-body">

      <!-- Add new signatory -->
      <form
        method="POST"
        action="{{ url_for('admin.create_letter_signatory') }}"
        class="row g-3 align-items-end"
      >
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

        <div class="col-md-4">
          <label class="form-label">Name</label>
          <input
            type="text"
            name="name"
            class="form-control"
            placeholder="Name"
            required
          >
        </div>

        <div class="col-md-4">
          <label class="form-label">Designation</label>
          <input
            type="text"
            name="designation"
            class="form-control"
            placeholder="Designation"
            required
          >
        </div>

        <div class="col-md-2">
          <label class="form-label">Sort Order</label>
          <input
            type="number"
            name="sort_order"
            class="form-control"
            value="1"
            min="1"
            step="1"
          >
        </div>

        <div class="col-md-2">
          <div class="form-check mt-4">
            <input
              class="form-check-input"
              type="checkbox"
              name="is_active"
              id="lsAddIsActive"
              checked
            >
            <label class="form-check-label" for="lsAddIsActive">
              Active
            </label>
          </div>
        </div>

        <div class="col-12 text-end">
          <button type="submit" class="btn btn-secondary">
            Add Signatory
          </button>
        </div>
      </form>

      <hr class="my-3">

      <!-- Existing signatories list -->
      {% if letter_signatories and letter_signatories|length > 0 %}
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead>
              <tr>
                <th style="width: 60px;">ID</th>
                <th>Name</th>
                <th>Designation</th>
                <th style="width: 110px;">Sort</th>
                <th style="width: 110px;">Status</th>
                <th style="width: 260px;" class="text-end">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for s in letter_signatories %}
                <tr class="{% if not s.is_active %}table-light text-muted{% endif %}">
                  <td>{{ s.id }}</td>
                  <td>{{ s.name }}</td>
                  <td>{{ s.designation }}</td>
                  <td>{{ s.sort_order }}</td>
                  <td>
                    {% if s.is_active %}
                      <span class="badge bg-success">Active</span>
                    {% else %}
                      <span class="badge bg-secondary">Inactive</span>
                    {% endif %}
                  </td>
                  <td class="text-end">

                    <!-- Toggle -->
                    <form
                      method="POST"
                      action="{{ url_for('admin.toggle_letter_signatory', signatory_id=s.id) }}"
                      class="d-inline"
                    >
                      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                      {% if s.is_active %}
                        <button type="submit" class="btn btn-sm btn-outline-danger">
                          Disable
                        </button>
                      {% else %}
                        <button type="submit" class="btn btn-sm btn-outline-success">
                          Enable
                        </button>
                      {% endif %}
                    </form>

                    <!-- Edit (simple collapse, no JS needed beyond Bootstrap) -->
                    <button
                      class="btn btn-sm btn-outline-primary"
                      type="button"
                      data-bs-toggle="collapse"
                      data-bs-target="#lsEdit{{ s.id }}"
                      aria-expanded="false"
                      aria-controls="lsEdit{{ s.id }}"
                    >
                      Edit
                    </button>
                  </td>
                </tr>

                <tr class="collapse" id="lsEdit{{ s.id }}">
                  <td colspan="6">
                    <form
                      method="POST"
                      action="{{ url_for('admin.update_letter_signatory', signatory_id=s.id) }}"
                      class="row g-2 align-items-end"
                    >
                      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                      <div class="col-md-4">
                        <label class="form-label small mb-1">Name</label>
                        <input type="text" name="name" class="form-control form-control-sm" value="{{ s.name }}" required>
                      </div>

                      <div class="col-md-4">
                        <label class="form-label small mb-1">Designation</label>
                        <input type="text" name="designation" class="form-control form-control-sm" value="{{ s.designation }}" required>
                      </div>

                      <div class="col-md-2">
                        <label class="form-label small mb-1">Sort Order</label>
                        <input type="number" name="sort_order" class="form-control form-control-sm" value="{{ s.sort_order }}" min="1" step="1">
                      </div>

                      <div class="col-md-2">
                        <div class="form-check mt-3">
                          <input class="form-check-input" type="checkbox" name="is_active" id="lsEditActive{{ s.id }}" {% if s.is_active %}checked{% endif %}>
                          <label class="form-check-label small" for="lsEditActive{{ s.id }}">Active</label>
                        </div>
                      </div>

                      <div class="col-12 text-end">
                        <button type="submit" class="btn btn-sm btn-primary">
                          Save Changes
                        </button>
                      </div>
                    </form>
                  </td>
                </tr>

              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="alert alert-info mb-0">
          No signatories added yet. Use the form above to add one.
        </div>
      {% endif %}

      <div class="form-text mt-2">
        Tip: Disable (Inactive) signatories instead of deleting when an officer is transferred or on leave.
      </div>

    </div>
  </div>

</div>

<!-- Datalist for home depot location search -->
<datalist id="configHomeLocationList">
  {% for loc in all_locations %}
    <option value="{{ loc.name }} [{{ loc.code }}]"></option>
  {% endfor %}
</datalist>
