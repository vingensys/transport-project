<div class="container-fluid">

  <h4 class="mb-3">Booking History</h4>

  <div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
      <div>
        All Bookings
        {% if active_agreement %}
          <small class="text-muted ms-2">
            (Active agreement: {{ active_agreement.id }} – {{ active_agreement.company.name }})
          </small>
        {% endif %}
      </div>

      <form
        method="get"
        action="{{ url_for('admin.dashboard') }}#history"
        class="d-flex align-items-center mb-0"
      >
        <label for="historyScopeSelect" class="form-label form-label-sm mb-0 me-2">
          Scope
        </label>
        <select
          class="form-select form-select-sm"
          id="historyScopeSelect"
          name="booking_scope"
          onchange="this.form.submit()"
        >
          <option value="active" {% if booking_scope == 'active' %}selected{% endif %}>
            Active agreement
          </option>
          <option value="all" {% if booking_scope == 'all' %}selected{% endif %}>
            All agreements
          </option>
        </select>
      </form>
    </div>

    <div class="card-body p-0">
      {% if booking_rows %}
        <div class="table-responsive mb-0">
          <table class="table table-bordered table-striped align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th style="width: 6%;">Trip ID</th>
                <th style="width: 9%;">Booking Date</th>
                <th style="width: 9%;">Placement</th>
                <th style="width: 10%;">Lorry</th>
                <th style="width: 18%;">From (Authority / Location)</th>
                <th style="width: 18%;">Destination (Authority / Location)</th>
                <th style="width: 8%;">KM</th>
                <th style="width: 8%;">Status</th>
                <th style="width: 14%;" class="text-center">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for row in booking_rows %}
                {% set b = row.booking %}
                <tr>
                  <!-- Trip ID -->
                  <td class="text-nowrap">{{ row.trip_serial }}</td>

                  <!-- Dates -->
                  <td class="text-nowrap">{{ b.booking_date }}</td>
                  <td class="text-nowrap">{{ b.placement_date }}</td>

                  <!-- Lorry -->
                  <td class="text-nowrap">{{ b.lorry.capacity }} Ton</td>

                  <!-- From / Dest -->
                  <td>
                    <span
                      title="{{ row.from_display_long }}"
                      class="small"
                    >
                      {{ row.from_display_short }}
                    </span>
                  </td>
                  <td>
                    <span
                      title="{{ row.dest_display_long }}"
                      class="small"
                    >
                      {{ row.dest_display_short }}
                    </span>
                  </td>

                  <!-- KM -->
                  <td class="text-nowrap">{{ b.trip_km }}</td>

                  <!-- Status -->
                  <td class="text-nowrap">
                    {% if b.status == 'CANCELLED' %}
                      <span class="badge bg-danger">Cancelled</span>
                    {% elif b.status == 'ACTIVE' %}
                      <span class="badge bg-success">Active</span>
                    {% else %}
                      <span class="badge bg-secondary">{{ b.status }}</span>
                    {% endif %}
                  </td>

                  <!-- Actions -->
                  <td class="text-center text-nowrap">
                    <!-- Details: opens global bookingDetailModal -->
                    <button
                      type="button"
                      class="btn btn-sm btn-outline-primary px-2 me-1"
                      data-bs-toggle="modal"
                      data-bs-target="#bookingDetailModal"
                      data-booking-id="{{ b.id }}"
                      data-trip-serial="{{ row.trip_serial }}"
                      data-booking-date="{{ b.booking_date }}"
                      data-placement-date="{{ b.placement_date }}"
                      data-company="{{ b.company.name }}"
                      data-lorry="{{ b.lorry.capacity }} Ton"
                      data-from="{{ row.from_display_long }}"
                      data-dest="{{ row.dest_display_long }}"
                      data-route="{{ b.route.name }}"
                      data-trip-km="{{ b.trip_km }}"
                    >
                      Details
                    </button>

                    <!-- Cancel (soft delete) from History tab -->
                    <form
                      method="POST"
                      action="{{ url_for('admin.cancel_booking', booking_id=b.id) }}"
                      class="d-inline"
                    >
                      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                      <input type="hidden" name="redirect_tab" value="#history">

                      {% if b.status == 'ACTIVE' %}
                        <button
                          type="submit"
                          class="btn btn-sm btn-outline-danger px-2 me-1"
                          onclick="return confirm('Cancel this booking?');"
                        >
                          Cancel
                        </button>
                      {% else %}
                        <button
                          type="button"
                          class="btn btn-sm btn-outline-secondary px-2 me-1"
                          disabled
                        >
                          Cancelled
                        </button>
                      {% endif %}
                    </form>

                    <!-- View/Edit stub – to be wired later -->
                    <a
                        href="{{ url_for('admin.booking_detail', booking_id=b.id) }}"
                        class="btn btn-sm btn-outline-secondary px-2"
                    >
                        View / Edit
                    </a>

                  </td>

                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <p class="text-muted m-3">No bookings found.</p>
      {% endif %}
    </div>
  </div>

</div>
