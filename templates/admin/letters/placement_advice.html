{% extends "admin/base.html" %}

{% block content %}
<div class="container-fluid mt-3">

  <div class="d-flex justify-content-between align-items-start mb-3">
    <div>
      <h5 class="mb-1">
        {% if baseline_letter %}
          Placement Advice — Booking #{{ booking.id }}
        {% else %}
          Generate Placement Advice — Booking #{{ booking.id }}
        {% endif %}
      </h5>
      <div class="small text-muted">
        {% if baseline_letter %}
          Issued Placement Advice and Modification Advice (if required).
        {% else %}
          Create Placement Advice PDF for this booking.
        {% endif %}
      </div>
    </div>

    <div class="d-flex gap-2">
      <a
        href="{{ url_for('admin.dashboard',
                         booking_scope=request.args.get('booking_scope'),
                         booking_status=request.args.get('booking_status'),
                         booking_search=request.args.get('booking_search')) }}#history"
        class="btn btn-sm btn-outline-secondary"
      >
        ← Back to History
      </a>

      <a
        href="{{ url_for('admin.booking_detail',
                         booking_id=booking.id,
                         booking_scope=request.args.get('booking_scope'),
                         booking_status=request.args.get('booking_status'),
                         booking_search=request.args.get('booking_search')) }}"
        class="btn btn-sm btn-outline-secondary"
      >
        ← Back to Booking Detail
      </a>
    </div>
  </div>

  <form
    method="POST"
    action="{{ url_for('admin.generate_placement_advice', booking_id=booking.id) }}"
    enctype="multipart/form-data"
    class="card"
  >
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <input type="hidden" name="booking_scope" value="{{ request.args.get('booking_scope','') }}">
    <input type="hidden" name="booking_status" value="{{ request.args.get('booking_status','') }}">
    <input type="hidden" name="booking_search" value="{{ request.args.get('booking_search','') }}">

    <div class="card-body">

      {% if baseline_letter %}
        <div class="alert alert-success mb-3">
          <strong>Placement Advice already issued.</strong>
          <div class="small mt-1">
            Letter Date: {{ baseline_letter.letter_date.strftime('%d-%m-%Y') if baseline_letter.letter_date else '-' }}
          </div>
        </div>
      {% endif %}

      <div class="row mb-3">
        <div class="col-md-3">
          <label class="form-label">Letter Date</label>
          <input
            type="date"
            name="letter_date"
            value="{{ (baseline_letter.letter_date.isoformat() if baseline_letter and baseline_letter.letter_date else default_letter_date) }}"
            required
          />

          <div class="form-text">
            {% if baseline_letter %}
              Date of the Modification Advice (if generated). Default is today when changes are detected.
            {% else %}
              Used in the generated Placement Advice PDF.
            {% endif %}
          </div>
        </div>
      </div>

      <!-- ===================================================== -->
      <!-- Letter Signatory selection -->
      <!-- ===================================================== -->
      <div class="row mb-3">
        <div class="col-md-6">
          <label class="form-label">Letter signed by</label>
          <select class="form-select" name="signed_by_id" required>
            {% if signatories and signatories|length > 0 %}
              {% set sel_by = default_signed_by_id %}
              <option value="" disabled {% if not sel_by %}selected{% endif %}>-- Select --</option>
              {% for s in signatories %}
                <option
                  value="{{ s.id }}"
                  {% if sel_by and (sel_by|string) == (s.id|string) %}selected{% endif %}
                >
                  {{ s.name }} — {{ s.designation }}
                </option>
              {% endfor %}
            {% else %}
              <option value="" selected disabled>No active signatories configured</option>
            {% endif %}
          </select>
          <div class="form-text">
            This prints the signatory name/designation block in the PDF.
          </div>
        </div>

        <div class="col-md-6">
          <label class="form-label">For</label>
          <select class="form-select" name="signed_for_id" required>
            {% if signatories and signatories|length > 0 %}
              {% set sel_for = default_signed_for_id %}
              <option value="" disabled {% if not sel_for %}selected{% endif %}>-- Select --</option>
              {% for s in signatories %}
                <option
                  value="{{ s.id }}"
                  {% if sel_for and (sel_for|string) == (s.id|string) %}selected{% endif %}
                >
                  {{ s.name }} — {{ s.designation }}
                </option>
              {% endfor %}
            {% else %}
              <option value="" selected disabled>No active signatories configured</option>
            {% endif %}
          </select>
          <div class="form-text">
            If different from “signed by”, PDF will show: Name + Designation + “For &lt;Designation&gt;”.
          </div>
        </div>
      </div>

      {% if requires_attachment %}
        <div class="alert alert-warning">
          This booking contains <strong>ATTACHED</strong> material scope(s).
          Please upload the material list PDF to be appended to the issued Placement Advice.
        </div>

        <div class="row mb-3">
          <div class="col-md-6">
            <label class="form-label">Material Attachment (PDF)</label>
            <input
              type="file"
              name="attachment_pdf"
              accept="application/pdf"
              class="form-control"
              required
            >
          </div>
        </div>
      {% endif %}

      {% if baseline_letter %}
        <div class="mt-2">
          {% if baseline_has_snapshot %}
            {% if changes_detected %}
              <span class="badge bg-warning text-dark">
                Changes detected since issued Placement Advice
              </span>

              {% if existing_mod_letter %}
                <span class="badge bg-success ms-2">
                  Matching Modification Advice already exists
                </span>
              {% else %}
                <span class="badge bg-danger ms-2">
                  No Modification Advice issued for current changes
                </span>
              {% endif %}

            {% else %}
              <span class="badge bg-secondary">
                No changes detected since issued Placement Advice
              </span>
            {% endif %}
          {% else %}
            <span class="badge bg-info text-dark">
              Change detection not available for this issued letter
            </span>
          {% endif %}
        </div>
      {% endif %}

      {% if baseline_letter and baseline_has_snapshot and changes_detected and existing_mod_letter %}
        <div class="alert alert-info mt-3 mb-0">
          <strong>No need to generate again.</strong>
          A Modification Advice already exists for the current booking state.
          Use the download button below.
        </div>
      {% endif %}

      {% if not signatories or signatories|length == 0 %}
        <div class="alert alert-danger mt-3 mb-0">
          No active signatories found in master data. Please add them in Master → Config.
        </div>
      {% endif %}

    </div>

    <div class="card-footer d-flex justify-content-between">
      <a
        href="{{ url_for('admin.booking_detail',
                         booking_id=booking.id,
                         booking_scope=request.args.get('booking_scope'),
                         booking_status=request.args.get('booking_status'),
                         booking_search=request.args.get('booking_search')) }}"
        class="btn btn-outline-secondary"
      >
        ← Back
      </a>

      <div class="d-flex gap-2">

        {% if baseline_letter %}
          <!-- Baseline download -->
          <a
            href="{{ url_for('admin.generate_placement_advice',
                 booking_id=booking.id,
                 download=1,
                 booking_scope=request.args.get('booking_scope'),
                 booking_status=request.args.get('booking_status'),
                 booking_search=request.args.get('booking_search')) }}"
            class="btn btn-outline-primary"
          >
            Download Placement Advice
          </a>

          <!-- MOD area -->
          {% if baseline_has_snapshot and changes_detected %}

            {% if existing_mod_letter %}
              <a
                href="{{ url_for('admin.generate_placement_advice', booking_id=booking.id, download_mod=1) }}"
                class="btn btn-outline-success"
              >
                Download Modification Advice
              </a>

              <button class="btn btn-warning" disabled title="A matching Modification Advice already exists for current changes.">
                Generate Modification Advice
              </button>
            {% else %}
              <button class="btn btn-warning" {% if not signatories or signatories|length == 0 %}disabled{% endif %}>
                Generate Modification Advice
              </button>
            {% endif %}

          {% else %}
            <button class="btn btn-warning" disabled>
              Generate Modification Advice
            </button>
          {% endif %}

        {% else %}
          <button class="btn btn-primary" {% if not signatories or signatories|length == 0 %}disabled{% endif %}>
            Generate Placement Advice
          </button>
        {% endif %}

      </div>
    </div>

  </form>

</div>
{% endblock %}
