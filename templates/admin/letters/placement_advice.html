{% extends "admin/base.html" %}

{% block content %}
<div class="container-fluid mt-3">

  <div class="d-flex justify-content-between align-items-start mb-3">
    <div>
      <h5 class="mb-1">
        {% if baseline_letter %}
          Placement Advice — Booking #{{ booking.id }}
        {% else %}
          Generate Placement Advice — Booking #{{ booking.id }}
        {% endif %}
      </h5>
      <div class="small text-muted">
        {% if baseline_letter %}
          Issued Placement Advice and Modification Advice (if required).
        {% else %}
          Create Placement Advice PDF for this booking.
        {% endif %}
      </div>
    </div>

    <div class="d-flex gap-2">
      <a
        href="{{ url_for('admin.dashboard',
                         booking_scope=request.args.get('booking_scope'),
                         booking_status=request.args.get('booking_status'),
                         booking_search=request.args.get('booking_search')) }}#history"
        class="btn btn-sm btn-outline-secondary"
      >
        ← Back to History
      </a>

      <a
        href="{{ url_for('admin.booking_detail',
                         booking_id=booking.id,
                         booking_scope=request.args.get('booking_scope'),
                         booking_status=request.args.get('booking_status'),
                         booking_search=request.args.get('booking_search')) }}"
        class="btn btn-sm btn-outline-secondary"
      >
        ← Back to Booking Detail
      </a>
    </div>
  </div>

  <form
    method="POST"
    action="{{ url_for('admin.generate_placement_advice', booking_id=booking.id) }}"
    enctype="multipart/form-data"
    class="card"
  >
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

    <div class="card-body">

      {% if baseline_letter %}
        <div class="alert alert-success mb-3">
          <strong>Placement Advice already issued.</strong>
          <div class="small mt-1">
            Letter Date: {{ baseline_letter.letter_date.strftime('%d-%m-%Y') if baseline_letter.letter_date else '-' }}
          </div>
        </div>
      {% endif %}

      <div class="row mb-3">
        <div class="col-md-3">
          <label class="form-label">Letter Date</label>
          <input
            type="date"
            name="letter_date"
            class="form-control"
            value="{% if booking.placement_date %}{{ booking.placement_date.isoformat() }}{% else %}{{ default_letter_date }}{% endif %}"
            required
          >
          <div class="form-text">
            {% if baseline_letter %}
              Date of the Modification Advice (if generated).
            {% else %}
              Used in the generated Placement Advice PDF.
            {% endif %}
          </div>
        </div>
      </div>

      {% if requires_attachment %}
        <div class="alert alert-warning">
          This booking contains <strong>ATTACHED</strong> material scope(s).
          Please upload the material list PDF to be appended to the issued Placement Advice.
        </div>

        <div class="row mb-3">
          <div class="col-md-6">
            <label class="form-label">Material Attachment (PDF)</label>
            <input
              type="file"
              name="attachment_pdf"
              accept="application/pdf"
              class="form-control"
              required
            >
          </div>
        </div>
      {% endif %}

      {% if baseline_letter %}
        <div class="mt-2">
          {% if baseline_has_snapshot %}
            {% if changes_detected %}
              <span class="badge bg-warning text-dark">
                Changes detected since issued Placement Advice
              </span>
            {% else %}
              <span class="badge bg-secondary">
                No changes detected since issued Placement Advice
              </span>
            {% endif %}
          {% else %}
            <span class="badge bg-info text-dark">
              Change detection not available for this issued letter
            </span>
          {% endif %}
        </div>
      {% endif %}

    </div>

    <div class="card-footer d-flex justify-content-between">
      <a
        href="{{ url_for('admin.booking_detail',
                         booking_id=booking.id,
                         booking_scope=request.args.get('booking_scope'),
                         booking_status=request.args.get('booking_status'),
                         booking_search=request.args.get('booking_search')) }}"
        class="btn btn-outline-secondary"
      >
        ← Back
      </a>

      <div class="d-flex gap-2">

        {% if baseline_letter %}
          <a
            href="{{ url_for('admin.generate_placement_advice', booking_id=booking.id, download=1) }}"
            class="btn btn-outline-primary"
          >
            Download Placement Advice
          </a>

          {% if baseline_has_snapshot and changes_detected %}
            <button class="btn btn-warning">
              Generate Modification Advice
            </button>
          {% else %}
            <button class="btn btn-warning" disabled>
              Generate Modification Advice
            </button>
          {% endif %}

        {% else %}
          <button class="btn btn-primary">
            Generate Placement Advice
          </button>
        {% endif %}

      </div>
    </div>

  </form>

</div>
{% endblock %}
