<div class="container">

  <h4 class="mb-3">Bookings</h4>

  <!-- Booking builder -->
  <form method="POST" action="{{ url_for('admin.add_booking') }}">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

    <div class="card mb-4 border-2 border-primary-subtle" style="background:#f0f7ff;">
      <div class="card-header bg-primary text-white">
          New Booking
      </div>
      <div class="card-body">
        <div class="row">
          <!-- FROM / LOADING side -->
          <div class="col-lg-6 mb-3">
            <div class="border rounded p-3 h-100">
              <h5 class="mb-2">FROM Side (Loading)</h5>

              <div class="input-group mb-2">
                <input
                  type="text"
                  class="form-control"
                  placeholder="Type name or code..."
                  list="bookingLocationList"
                  data-role="from-booking-input"
                >
                <button
                  class="btn btn-outline-secondary"
                  type="button"
                  data-role="from-booking-add"
                >
                  Add
                </button>
              </div>

              <ul class="list-group small" id="fromBookingLocationList">
                <!-- JS will append FROM locations here -->
              </ul>
            </div>
          </div>

          <!-- DESTINATION / UNLOADING side -->
          <div class="col-lg-6 mb-3">
            <div class="border rounded p-3 h-100">
              <h5 class="mb-2">DESTINATION Side (Unloading)</h5>

              <div class="input-group mb-2">
                <input
                  type="text"
                  class="form-control"
                  placeholder="Type name or code..."
                  list="bookingLocationList"
                  data-role="dest-booking-input"
                >
                <button
                  class="btn btn-outline-secondary"
                  type="button"
                  data-role="dest-booking-add"
                >
                  Add
                </button>
              </div>

              <ul class="list-group small" id="destBookingLocationList">
                <!-- JS will append DEST locations here -->
              </ul>
            </div>
          </div>
        </div>

        <hr class="my-3">

        <!-- Placement Date, Distance & Lorry selection -->
        <div class="row align-items-end">
          <div class="col-md-3 mb-3">
            <label for="bookingPlacementDate" class="form-label">Placement Date</label>
            <input
              type="date"
              class="form-control"
              id="bookingPlacementDate"
              name="placement_date"
              required
            >
          </div>

          <div class="col-md-3 mb-3">
            <label for="bookingTripKm" class="form-label">Distance (KM)</label>
            <input
              type="number"
              class="form-control"
              id="bookingTripKm"
              name="trip_km"
              min="1"
              step="1"
              required
            >
          </div>

          <div class="col-md-3 mb-3">
            <label for="bookingLorry" class="form-label">Lorry</label>
            <select
                class="form-select"
                id="bookingLorry"
                name="lorry_id"
                required
            >
                <option value="">-- Select Lorry --</option>
                {% for l in lorries %}
                <option value="{{ l.id }}">
                    {{ l.capacity }} / {{ l.carrier_size }} / {{ l.number_of_wheels }} wheels
                </option>
                {% endfor %}
            </select>
          </div>

          <div class="col-md-3 mb-3 text-end">
            <button type="submit" class="btn btn-primary mt-4">
              Save Booking
            </button>
          </div>
        </div>
      </div>
    </div>
  </form>

  <!-- Existing bookings table -->
  {% if bookings %}
    <div class="table-responsive">
      <table class="table table-bordered table-striped align-middle">
        <thead class="table-light">
          <tr>
            <th>ID</th>
            <th>Placement Date</th>
            <th>Booked On</th>
            <th>Company</th>
            <th>Lorry</th>
            <th>Route</th>
            <th>KMs</th>
          </tr>
        </thead>
        <tbody>
          {% for b in bookings %}
            <tr>
              <td>{{ b.id }}</td>
              <td>{{ b.placement_date }}</td>
              <td>{{ b.booking_date }}</td>
              <td>{{ b.company.name }}</td>
              <td>
                {{ b.lorry.capacity }} / {{ b.lorry.carrier_size }} / {{ b.lorry.number_of_wheels }} wheels
              </td>
              <td>{{ b.route.name }}</td>
              <td>{{ b.trip_km }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <p class="text-muted">No bookings added yet.</p>
  {% endif %}

</div>

<!-- Datalist for booking location search -->
<datalist id="bookingLocationList">
  {% for loc in all_locations %}
    <option value="{{ loc.name }} [{{ loc.code }}]"></option>
  {% endfor %}
</datalist>

<!-- Authority Picker Modal -->
<div class="modal fade" id="authorityPickerModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">Select Authorities</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="authorityPickerList" class="d-flex flex-column gap-2 mb-2">
          <!-- JS injects authority checkboxes here -->
        </div>
        <div id="authorityPickerEmpty" class="text-muted small d-none mb-2">
          No authorities found for this location.
        </div>

        <hr class="my-3">

        <div class="mb-2">
          <h6 class="mb-2">Add new authority at this location</h6>
          <div class="row g-2 align-items-end">
            <div class="col-md-5">
              <label for="newAuthorityTitle" class="form-label form-label-sm mb-1">Designation</label>
              <input type="text" class="form-control form-control-sm" id="newAuthorityTitle"
                     placeholder="e.g. Station Master" />
            </div>
            <div class="col-md-5">
              <label for="newAuthorityAddress" class="form-label form-label-sm mb-1">Address (optional)</label>
              <input type="text" class="form-control form-control-sm" id="newAuthorityAddress"
                     placeholder="Office / contact details" />
            </div>
            <div class="col-md-2">
              <button type="button" class="btn btn-sm btn-success w-100 mt-4" id="btnAddAuthority">
                Add
              </button>
            </div>
          </div>
          <div class="small mt-1" id="newAuthorityStatus"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" id="applyAuthoritySelection" class="btn btn-primary">
          Apply Selection
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Bridge: server â†’ JS -->
<script>
  window.BOOKING_AUTH_BY_CODE = {{ booking_auth_map|tojson }};
  window.FLASK_QUICK_ADD_AUTHORITY_URL = "{{ url_for('admin.quick_add_authority') }}";
</script>
