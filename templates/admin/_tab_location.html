<h5 class="mb-3">Locations</h5>

<button
  class="btn btn-primary mb-3"
  data-bs-toggle="modal"
  data-bs-target="#addLocationModal"
>
  Add Location
</button>

<div class="card mb-3">
  <div class="card-header">
    Search Locations (first 200 by code)
  </div>
  <div class="card-body">
    <div class="row g-3 align-items-center">
      <div class="col-auto">
        <label for="locationSearchInput" class="col-form-label">Filter:</label>
      </div>
      <div class="col-md-4">
        <input
          id="locationSearchInput"
          type="text"
          class="form-control"
          placeholder="Type code or name..."
        >
      </div>
      <div class="col-auto">
        <small class="text-muted">
          Client-side filter on the first 200 locations.
        </small>
      </div>
    </div>
  </div>
</div>

<!-- Edit Location By Code -->
<div class="card mt-4">
  <div class="card-header">
    Edit Location by Code
  </div>
  <div class="card-body">
    <p class="text-muted mb-2">
      Use the search box above to find the existing location details, then update them here.
    </p>
    <form method="POST" action="{{ url_for('admin.edit_location') }}">
      <div class="row g-3">
        <div class="col-md-3">
            <label class="form-label">Code</label>
            <input
                class="form-control"
                name="code"
                list="locationCodeOptions"
                maxlength="10"
                placeholder="Type or pick e.g., ED"
                required
                data-role="edit-location-code"
            >
            <datalist id="locationCodeOptions">
                {% for loc in locations.items %}
                    <option value="{{ loc.code }}">{{ loc.code }} - {{ loc.name }}</option>
                {% endfor %}
            </datalist>

        </div>
        <div class="col-md-4">
            <label class="form-label">New Name (leave blank to keep)</label>
            <input
                class="form-control"
                name="name"
                placeholder="e.g., Erode Junction"
                data-role="edit-location-name"
            >
            </div>
            <div class="col-md-5">
            <label class="form-label">New Address (blank to clear)</label>
            <input
                class="form-control"
                name="address"
                placeholder="Optional updated address"
                data-role="edit-location-address"
            >
        </div>
      </div>
      <button class="btn btn-outline-primary mt-3">
        Update Location
      </button>
    </form>
  </div>
</div>

{% if locations %}
  <div class="table-responsive">
    <table class="table table-sm table-bordered align-middle" id="locationTable">
      <thead class="table-light">
        <tr>
          <th style="width: 60px;">ID</th>
          <th style="width: 90px;">Code</th>
          <th>Name</th>
          <th>Address</th>
        </tr>
      </thead>
      <tbody>
      {% for loc in locations.items %}
        <tr
          data-code="{{ loc.code }}"
          data-name="{{ loc.name }}"
          data-address="{{ loc.address or '' }}"
        >
          <td>{{ loc.id }}</td>
          <td>{{ loc.code }}</td>
          <td>{{ loc.name }}</td>
          <td>{{ loc.address or "-" }}</td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>
{% else %}
  <p class="text-muted mt-2">No locations found in the database.</p>
{% endif %}

<!-- Pagination Controls -->
<nav class="mt-3">
  <ul class="pagination pagination-sm justify-content-center flex-wrap">

    {# First page #}
    <li class="page-item {% if loc_page == 1 %}disabled{% endif %}">
      <a class="page-link"
         href="{{ url_for('admin.dashboard', loc_page=1) }}#location">
        « First
      </a>
    </li>

    {# Jump back 5 pages #}
    {% set back5 = loc_page - 5 %}
    {% if back5 >= 1 %}
      <li class="page-item">
        <a class="page-link"
           href="{{ url_for('admin.dashboard', loc_page=back5) }}#location">
          ‹‹ -5
        </a>
      </li>
    {% else %}
      <li class="page-item disabled"><span class="page-link">‹‹ -5</span></li>
    {% endif %}

    {# Previous page #}
    {% if locations.has_prev %}
      <li class="page-item">
        <a class="page-link"
           href="{{ url_for('admin.dashboard', loc_page=locations.prev_num) }}#location">
          ‹ Prev
        </a>
      </li>
    {% else %}
      <li class="page-item disabled"><span class="page-link">‹ Prev</span></li>
    {% endif %}

    {# Page window with ellipses #}
    {% if loc_start_page > 1 %}
      <li class="page-item disabled"><span class="page-link">…</span></li>
    {% endif %}

    {% for p in range(loc_start_page, loc_end_page + 1) %}
      <li class="page-item {% if p == loc_page %}active{% endif %}">
        <a class="page-link"
           href="{{ url_for('admin.dashboard', loc_page=p) }}#location">
          {{ p }}
        </a>
      </li>
    {% endfor %}

    {% if loc_end_page < loc_total_pages %}
      <li class="page-item disabled"><span class="page-link">…</span></li>
    {% endif %}

    {# Next page #}
    {% if locations.has_next %}
      <li class="page-item">
        <a class="page-link"
           href="{{ url_for('admin.dashboard', loc_page=locations.next_num) }}#location">
          Next ›
        </a>
      </li>
    {% else %}
      <li class="page-item disabled"><span class="page-link">Next ›</span></li>
    {% endif %}

    {# Jump forward 5 pages #}
    {% set fwd5 = loc_page + 5 %}
    {% if fwd5 <= loc_total_pages %}
      <li class="page-item">
        <a class="page-link"
           href="{{ url_for('admin.dashboard', loc_page=fwd5) }}#location">
          +5 ››
        </a>
      </li>
    {% else %}
      <li class="page-item disabled"><span class="page-link">+5 ››</span></li>
    {% endif %}

    {# Last page #}
    <li class="page-item {% if loc_page == loc_total_pages %}disabled{% endif %}">
      <a class="page-link"
         href="{{ url_for('admin.dashboard', loc_page=loc_total_pages) }}#location">
        Last »
      </a>
    </li>

  </ul>
</nav>

<div class="d-flex justify-content-center align-items-center mt-2">
  <small class="me-2 text-muted">
    Page {{ loc_page }} of {{ loc_total_pages }}
  </small>

  <form id="locGotoForm"
        class="d-flex align-items-center"
        onsubmit="return false;"
        data-base-url="{{ url_for('admin.dashboard') }}"
        data-max-pages="{{ loc_total_pages }}">
    <label class="me-1 mb-0">Go to:</label>
    <input id="locGotoInput" type="number" min="1" max="{{ loc_total_pages }}"
           class="form-control form-control-sm me-1"
           style="width: 80px;">
    <button class="btn btn-sm btn-outline-secondary" type="button" id="locGotoBtn">
      Go
    </button>
  </form>
</div>

<!-- Add Location Modal -->
<div class="modal fade" id="addLocationModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">

      <form method="POST" action="{{ url_for('admin.add_location') }}">
        <div class="modal-header">
          <h5 class="modal-title">Add Location</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Location Code</label>
            <input
              class="form-control"
              name="code"
              maxlength="10"
              placeholder="e.g., ED"
              required
            >
          </div>

          <div class="mb-3">
            <label class="form-label">Location Name</label>
            <input
              class="form-control"
              name="name"
              placeholder="e.g., Erode Junction"
              required
            >
          </div>

          <div class="mb-3">
            <label class="form-label">Address (optional)</label>
            <textarea class="form-control" name="address"></textarea>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            Cancel
          </button>
          <button class="btn btn-primary">Add</button>
        </div>
      </form>

    </div>
  </div>
</div>

<script>
  // Go-to-page logic for Locations pagination
  document.addEventListener("DOMContentLoaded", function () {
    const form = document.getElementById("locGotoForm");
    if (!form) return;

    const input = document.getElementById("locGotoInput");
    const btn = document.getElementById("locGotoBtn");
    const baseUrl = form.getAttribute("data-base-url");
    const maxPages = parseInt(form.getAttribute("data-max-pages"), 10);

    function goToPage() {
      if (!input || !baseUrl || !maxPages) return;
      let p = parseInt(input.value, 10);
      if (isNaN(p)) return;
      if (p < 1) p = 1;
      if (p > maxPages) p = maxPages;
      window.location.href = baseUrl + "?loc_page=" + p + "#location";
    }

    btn.addEventListener("click", goToPage);
    input.addEventListener("keydown", function (e) {
      if (e.key === "Enter") {
        e.preventDefault();
        goToPage();
      }
    });
  });
</script>

<script>
  // Simple client-side filter for the locations table
  document.addEventListener("DOMContentLoaded", function () {
    const input = document.getElementById("locationSearchInput");
    const table = document.getElementById("locationTable");
    if (!input || !table) return;

    input.addEventListener("keyup", function () {
      const filter = input.value.toLowerCase();
      const rows = table.querySelectorAll("tbody tr");

      rows.forEach(function (row) {
        const text = row.innerText.toLowerCase();
        row.style.display = text.includes(filter) ? "" : "none";
      });
    });
  });
</script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const table = document.getElementById("locationTable");
    const codeInput = document.querySelector('input[data-role="edit-location-code"]');
    const nameInput = document.querySelector('input[data-role="edit-location-name"]');
    const addrInput = document.querySelector('input[data-role="edit-location-address"]');

    if (!table || !codeInput || !nameInput || !addrInput) return;

    function highlightRow(row) {
      const rows = table.querySelectorAll("tbody tr");
      rows.forEach(r => r.classList.remove("table-primary"));
      if (row) {
        row.classList.add("table-primary");
        row.scrollIntoView({ behavior: "smooth", block: "center" });
      }
    }

    function fillFromCode() {
      const code = codeInput.value.trim().toUpperCase();
      if (!code) {
        nameInput.value = "";
        addrInput.value = "";
        highlightRow(null);
        return;
      }

      const row = table.querySelector(`tbody tr[data-code="${code}"]`);
      if (row) {
        const name = row.getAttribute("data-name") || "";
        const address = row.getAttribute("data-address") || "";

        nameInput.value = name;
        addrInput.value = address;
        highlightRow(row);
      } else {
        // No matching row among the first 200
        nameInput.value = "";
        addrInput.value = "";
        highlightRow(null);
      }
    }

    codeInput.addEventListener("change", fillFromCode);
    codeInput.addEventListener("blur", fillFromCode);
  });
</script>

