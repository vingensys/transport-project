{% extends "admin/base.html" %}

{% block content %}

<div class="container-fluid">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="mb-0">
      Trip {{ trip_serial|default(booking.id) }}
      <small class="text-muted">
        (Booking #{{ booking.id }})
      </small>
    </h4>

    <div class="d-flex gap-2">
      {# Back to History – preserve filters if present #}
      <a
        href="{{ url_for('admin.dashboard',
                         booking_scope=request.args.get('booking_scope'),
                         booking_status=request.args.get('booking_status'),
                         booking_search=request.args.get('booking_search')) }}#history"
        class="btn btn-sm btn-outline-secondary"
      >
        ← Back to History
      </a>

      {# Booking tab (no filters needed) #}
      <a href="{{ url_for('admin.dashboard') }}#booking"
         class="btn btn-sm btn-outline-secondary">
        Go to Booking Tab
      </a>
    </div>
  </div>

  <!-- Header info: basic booking details -->
  <div class="card mb-3">
    <div class="card-header bg-light">
      Booking Summary
    </div>
    <div class="card-body">

      <div class="row mb-2">
        <div class="col-md-4">
          <strong>Booking #</strong><br>
          {{ booking.id }}
        </div>
        <div class="col-md-4">
          <strong>Company</strong><br>
          {{ booking.company.name if booking.company else '-' }}
        </div>
        <div class="col-md-4">
          <strong>Agreement</strong><br>
          {% if booking.agreement %}
            {{ booking.agreement.loa_number or 'Agreement' }}
          {% else %}
            -
          {% endif %}
        </div>
      </div>

      <div class="row mb-2">
        <div class="col-md-4">
          <strong>Booking Date</strong><br>
          {{ booking.booking_date }}
        </div>
        <div class="col-md-4">
          <strong>Placement Date</strong><br>
          {{ booking.placement_date }}
        </div>
        <div class="col-md-4">
          <strong>Status</strong><br>
          {% if booking.status == 'CANCELLED' %}
            <span class="badge bg-danger">Cancelled</span>
          {% elif booking.status == 'ACTIVE' or not booking.status %}
            <span class="badge bg-success">Active</span>
          {% else %}
            <span class="badge bg-secondary">{{ booking.status }}</span>
          {% endif %}
        </div>
      </div>

      <div class="row mb-2">
        <div class="col-md-4">
          <strong>Trip KM</strong><br>
          {{ booking.trip_km or '-' }}
        </div>
        <div class="col-md-4">
          <strong>Route</strong><br>
          {% if booking.route %}
            {{ booking.route.name }} ({{ booking.route.total_km }} KM)
          {% else %}
            -
          {% endif %}
        </div>
        <div class="col-md-4">
          <strong>Lorry</strong><br>
          {% if booking.lorry %}
            {{ booking.lorry.capacity }} Ton · {{ booking.lorry.number_of_wheels }} wheels · {{ booking.lorry.carrier_size }}
          {% else %}
            -
          {% endif %}
        </div>
      </div>

      {% if booking.remarks %}
        <div class="row mt-2">
          <div class="col-12">
            <strong>Remarks</strong><br>
            <pre class="mb-0">{{ booking.remarks }}</pre>
          </div>
        </div>
      {% endif %}

    </div>
  </div>

  <!-- Route / authorities summary -->
  <div class="card mb-3">
    <div class="card-header bg-light">
      Route &amp; Authorities
    </div>
    <div class="card-body">

      <div class="row">
        <div class="col-md-6 mb-3">
          <h6>Loading Side (FROM)</h6>
          <hr class="my-2">
          {% set loading_auths = booking.booking_authorities|selectattr('role','equalto','LOADING')|list %}
          {% if loading_auths %}
            <ul class="list-unstyled small mb-0">
              {% for ba in loading_auths %}
                <li class="mb-1">
                  {% if ba.authority %}
                    <strong>{{ ba.authority.authority_title }}</strong>
                    <br>
                    <span class="text-muted">
                      {% if ba.authority.location %}
                        {{ ba.authority.location.name }} [{{ ba.authority.location.code }}]
                      {% else %}
                        (No location)
                      {% endif %}
                    </span>
                    {% if ba.authority.address %}
                      <br>
                      <span class="text-muted">{{ ba.authority.address }}</span>
                    {% endif %}
                  {% else %}
                    <em class="text-muted">[Missing authority record]</em>
                  {% endif %}
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="text-muted mb-0">No loading authorities recorded.</p>
          {% endif %}
        </div>

        <div class="col-md-6 mb-3">
          <h6>Unloading Side (DESTINATION)</h6>
          <hr class="my-2">
          {% set unloading_auths = booking.booking_authorities|selectattr('role','equalto','UNLOADING')|list %}
          {% if unloading_auths %}
            <ul class="list-unstyled small mb-0">
              {% for ba in unloading_auths %}
                <li class="mb-1">
                  {% if ba.authority %}
                    <strong>{{ ba.authority.authority_title }}</strong>
                    <br>
                    <span class="text-muted">
                      {% if ba.authority.location %}
                        {{ ba.authority.location.name }} [{{ ba.authority.location.code }}]
                      {% else %}
                        (No location)
                      {% endif %}
                    </span>
                    {% if ba.authority.address %}
                      <br>
                      <span class="text-muted">{{ ba.authority.address }}</span>
                    {% endif %}
                  {% else %}
                    <em class="text-muted">[Missing authority record]</em>
                  {% endif %}
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="text-muted mb-0">No unloading authorities recorded.</p>
          {% endif %}
        </div>
      </div>

    </div>
  </div>

  <!-- Editable fields (placement_date, lorry_id) -->
  <div class="card mb-3">
    <div class="card-header bg-light">
      Edit Booking (Placement Date &amp; Lorry)
    </div>
    <div class="card-body">
      {% if booking.status == 'CANCELLED' %}
        <div class="alert alert-warning mb-3">
          This booking has been cancelled. Editing is disabled.
        </div>
      {% endif %}

      <form
        method="POST"
        action="{{ url_for('admin.booking_detail',
                          booking_id=booking.id,
                          booking_scope=request.args.get('booking_scope'),
                          booking_status=request.args.get('booking_status'),
                          booking_search=request.args.get('booking_search')) }}"
      >
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

        <div class="row g-3 align-items-end">
          <div class="col-md-4">
            <label for="placementDateDetail" class="form-label form-label-sm mb-1">
              Placement Date
            </label>
            <input
              type="date"
              id="placementDateDetail"
              name="placement_date"
              class="form-control form-control-sm"
              value="{{ booking.placement_date }}"
              {% if booking.status == 'CANCELLED' %}disabled{% endif %}
            >
          </div>

          <div class="col-md-4">
            <label for="lorryDetail" class="form-label form-label-sm mb-1">
              Lorry
            </label>
            <select
              id="lorryDetail"
              name="lorry_id"
              class="form-select form-select-sm"
              {% if booking.status == 'CANCELLED' %}disabled{% endif %}
            >
              <option value="">-- Select Lorry --</option>
              {% for l in lorries %}
                <option
                  value="{{ l.id }}"
                  {% if l.id == booking.lorry_id %}selected{% endif %}
                >
                  {{ l.capacity }} Ton · {{ l.number_of_wheels }} wheels · {{ l.carrier_size }}
                </option>
              {% endfor %}
            </select>
          </div>

          <div class="col-12 text-end">
            <button type="submit" class="btn btn-primary btn-sm"
                    {% if booking.status == 'CANCELLED' %}disabled{% endif %}>
              Save Booking
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Materials: editor on this page (markup only, JS lives in static js file) -->
  <div class="card mt-4">
    <div class="card-header bg-light d-flex justify-content-between align-items-center">
      <span>Materials</span>
      <small class="text-muted">
        Edit item-wise (ITEM) or lumpsum material list.
      </small>
    </div>
    <div class="card-body">
      {% set current_mode = material.mode if material else "" %}

      <form
        method="POST"
        action="{{ url_for('admin.booking_materials_edit', booking_id=booking.id) }}"
        id="materialEditFormDetail"
      >
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

        <div class="d-flex justify-content-between align-items-center mb-2">
          <div>
            <h6 class="mb-0">Material Details</h6>
            <small class="text-muted">
              ITEM mode: per-line Qty × Rate → Amount. LUMPSUM: descriptive lines + optional totals.
            </small>
          </div>
          <div class="ms-3" style="min-width: 220px;">
            <label for="materialModeDetail" class="form-label form-label-sm mb-1">Mode</label>
            <select
              class="form-select form-select-sm"
              id="materialModeDetail"
              name="material_mode"
            >
              <option value="" {% if not current_mode %}selected{% endif %}>(No Material List)</option>
              <option value="ITEM" {% if current_mode == 'ITEM' %}selected{% endif %}>Item-wise (ITEM)</option>
              <option value="LUMPSUM" {% if current_mode == 'LUMPSUM' %}selected{% endif %}>Lumpsum</option>
            </select>
          </div>
        </div>

        <div class="table-responsive mb-3">
          <table class="table table-sm table-bordered align-middle mb-0">
            <thead class="table-secondary">
              <tr class="text-center">
                <th style="width: 40px;">Sl.</th>
                <th>Description</th>
                <th style="width: 100px;">Unit</th>
                <th style="width: 110px;">Qty</th>
                <!-- widened -->
                <th style="width: 140px;">Rate</th>
                <th style="width: 170px;">Amount</th>
                <th style="width: 50px;"></th>
              </tr>
            </thead>
            <tbody id="materialLinesBodyDetail">
              {% if material and material.lines %}
                {% for line in material.lines %}
                  <tr>
                    <td class="text-center align-middle">
                      {{ loop.index }}
                    </td>
                    <td>
                      <input
                        type="text"
                        name="line_description[]"
                        class="form-control form-control-sm"
                        value="{{ line.description }}"
                        required
                      >
                    </td>
                    <td>
                      <input
                        type="text"
                        name="line_unit[]"
                        class="form-control form-control-sm"
                        value="{{ line.unit or '' }}"
                      >
                    </td>
                    <td>
                      <input
                        type="number"
                        name="line_quantity[]"
                        class="form-control form-control-sm material-qty"
                        step="0.001"
                        min="0"
                        value="{% if line.quantity is not none %}{{ '%.3f'|format(line.quantity) }}{% endif %}"
                      >
                    </td>
                    <td>
                      <input
                        type="number"
                        name="line_rate[]"
                        class="form-control form-control-sm material-rate"
                        step="0.01"
                        min="0"
                        value="{% if line.rate is not none %}{{ '%.2f'|format(line.rate) }}{% endif %}"
                      >
                    </td>
                    <td>
                      <input
                        type="number"
                        name="line_amount[]"
                        class="form-control form-control-sm material-amount"
                        step="0.01"
                        min="0"
                        value="{% if line.amount is not none %}{{ '%.2f'|format(line.amount) }}{% endif %}"
                      >
                    </td>
                    <td class="text-center">
                      <button
                        type="button"
                        class="btn btn-sm btn-outline-danger"
                        data-role="remove-material-line-detail"
                      >
                        ×
                      </button>
                    </td>
                  </tr>
                {% endfor %}
              {% else %}
                {# Render one empty row as a starting point #}
                <tr>
                  <td class="text-center align-middle">
                    1
                  </td>
                  <td>
                    <input
                      type="text"
                      name="line_description[]"
                      class="form-control form-control-sm"
                      value=""
                      required
                    >
                  </td>
                  <td>
                    <input
                      type="text"
                      name="line_unit[]"
                      class="form-control form-control-sm"
                      value=""
                    >
                  </td>
                  <td>
                    <input
                      type="number"
                      name="line_quantity[]"
                      class="form-control form-control-sm material-qty"
                      step="0.001"
                      min="0"
                    >
                  </td>
                  <td>
                    <input
                      type="number"
                      name="line_rate[]"
                      class="form-control form-control-sm material-rate"
                      step="0.01"
                      min="0"
                    >
                  </td>
                  <td>
                    <input
                      type="number"
                      name="line_amount[]"
                      class="form-control form-control-sm material-amount"
                      step="0.01"
                      min="0"
                    >
                  </td>
                  <td class="text-center">
                    <button
                      type="button"
                      class="btn btn-sm btn-outline-danger"
                      data-role="remove-material-line-detail"
                    >
                      ×
                    </button>
                  </td>
                </tr>
              {% endif %}
            </tbody>
          </table>
        </div>

        <!-- Totals (shown below list) -->
        <div class="row g-3 mt-3 align-items-end">
          <div class="col-md-4" id="materialTotalQtyGroupDetail">
            <label class="form-label form-label-sm mb-1">
              Total Quantity (LUMPSUM)
            </label>
            <div class="input-group input-group-sm">
              <input
                type="number"
                class="form-control"
                name="material_total_quantity"
                step="0.01"
                min="0"
                value="{% if material and material.total_quantity is not none %}{{ '%.3f'|format(material.total_quantity) }}{% endif %}"
                placeholder="e.g. 25.5"
              >
              <input
                type="text"
                class="form-control"
                name="material_total_quantity_unit"
                value="{% if material and material.total_quantity_unit %}{{ material.total_quantity_unit }}{% endif %}"
                placeholder="Unit (e.g. MT)"
              >
            </div>
          </div>

          <div class="col-md-4" id="materialTotalAmountGroupDetail">
            <label class="form-label form-label-sm mb-1">Total Amount</label>
            <div class="input-group input-group-sm">
              <span class="input-group-text">₹</span>
              <input
                type="number"
                class="form-control"
                name="material_total_amount"
                step="0.01"
                min="0"
                value="{% if material and material.total_amount is not none %}{{ '%.2f'|format(material.total_amount) }}{% endif %}"
                placeholder="Lumpsum / total"
              >
            </div>
          </div>

          <div class="col-md-4 d-flex align-items-end justify-content-end">
            <button
              type="button"
              class="btn btn-sm btn-outline-primary me-2"
              id="btnAddMaterialRowDetail"
              data-role="add-material-row-detail"
            >
              Add Row
            </button>
            <!-- Cancel = reload detail page, discarding unsaved edits -->
            <a
                href="{{ url_for('admin.booking_detail', booking_id=booking.id) }}"
                class="btn btn-sm btn-outline-secondary me-2"
            >
                Cancel
            </a>
            <button
              type="submit"
              class="btn btn-sm btn-success"
            >
              Save Materials
            </button>
          </div>
        </div>

        {# ---
           Summary line BELOW table
        --- #}
        {% set ns = namespace(any_qty=False) %}
        {% if material and material.lines %}
          {% for line in material.lines %}
            {% if line.quantity is not none %}
              {% set ns.any_qty = True %}
            {% endif %}
          {% endfor %}
        {% endif %}

        <div class="mt-2 small text-muted">
          {% if material %}
            {% if material.mode == 'LUMPSUM' %}
              {% if ns.any_qty %}
                {# Row quantities present → do NOT show header total quantity, only total amount if present #}
                {% if material.total_amount %}
                  <em>
                    Lumpsum mode: per-line quantities used.
                    Total amount recorded: ₹{{ '%.2f'|format(material.total_amount) }}.
                  </em>
                {% else %}
                  <em>
                    Lumpsum mode: per-line quantities used.
                    Total amount not recorded.
                  </em>
                {% endif %}
              {% else %}
                {# No row quantities → header total quantity (if any) is the only quantity #}
                {% if material.total_quantity is not none and material.total_quantity_unit %}
                  <em>
                    Lumpsum mode: total quantity
                    {{ '%.3f'|format(material.total_quantity) }}
                    {{ material.total_quantity_unit }}.
                  </em>
                  {% if material.total_amount %}
                    <em>
                      &nbsp; Total amount: ₹{{ '%.2f'|format(material.total_amount) }}.
                    </em>
                  {% endif %}
                {% elif material.total_amount %}
                  <em>
                    Lumpsum mode: total amount recorded: ₹{{ '%.2f'|format(material.total_amount) }}.
                  </em>
                {% else %}
                  <em>
                    Lumpsum mode: no total quantity or amount recorded.
                  </em>
                {% endif %}
              {% endif %}
            {% elif material.mode == 'ITEM' %}
              {% if material.total_amount %}
                <em>
                  Item-wise mode: total amount from line items
                  ₹{{ '%.2f'|format(material.total_amount) }}.
                </em>
              {% else %}
                <em>Item-wise mode: total amount not recorded.</em>
              {% endif %}
            {% else %}
              <em>Material mode not set.</em>
            {% endif %}
          {% else %}
            <em>No materials recorded yet.</em>
          {% endif %}
        </div>

      </form>
    </div>
  </div>

</div>

{% endblock %}
