{% extends "admin/base.html" %}

{% block content %}

<div class="container-fluid">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="mb-0">
      Trip {{ trip_serial|default(booking.id) }}
      <small class="text-muted">
        (Booking #{{ booking.id }})
      </small>
    </h4>

    <div class="d-flex gap-2">
      {# Back to History – preserve filters if present #}
      <a
        href="{{ url_for('admin.dashboard',
                         booking_scope=request.args.get('booking_scope'),
                         booking_status=request.args.get('booking_status'),
                         booking_search=request.args.get('booking_search')) }}#history"
        class="btn btn-sm btn-outline-secondary"
      >
        ← Back to History
      </a>

      {# Booking tab (no filters needed) #}
      <a href="{{ url_for('admin.dashboard') }}#booking"
         class="btn btn-sm btn-outline-secondary">
        Go to Booking Tab
      </a>
    </div>
  </div>

  <!-- Header info: basic booking details -->
  <div class="card mb-3">
    <div class="card-header bg-light">
      Booking Summary
    </div>
    <div class="card-body">

      <div class="row mb-2">
        <div class="col-md-4">
          <strong>Booking #</strong><br>
          {{ booking.id }}
        </div>
        <div class="col-md-4">
          <strong>Company</strong><br>
          {{ booking.company.name if booking.company else '-' }}
        </div>
        <div class="col-md-4">
          <strong>Agreement</strong><br>
          {% if booking.agreement %}
            {{ booking.agreement.loa_number or 'Agreement' }}
          {% else %}
            -
          {% endif %}
        </div>
      </div>

      <div class="row mb-2">
        <div class="col-md-4">
          <strong>Booking Date</strong><br>
          {{ booking.booking_date }}
        </div>
        <div class="col-md-4">
          <strong>Placement Date</strong><br>
          {{ booking.placement_date }}
        </div>
        <div class="col-md-4">
          <strong>Status</strong><br>
          {% if booking.status == 'CANCELLED' %}
            <span class="badge bg-danger">Cancelled</span>
          {% elif booking.status == 'ACTIVE' or not booking.status %}
            <span class="badge bg-success">Active</span>
          {% else %}
            <span class="badge bg-secondary">{{ booking.status }}</span>
          {% endif %}
        </div>
      </div>

      <div class="row mb-2">
        <div class="col-md-4">
          <strong>Trip KM</strong><br>
          {{ booking.trip_km or '-' }}
        </div>
        <div class="col-md-4">
          <strong>Route</strong><br>
          {% if booking.route %}
            {{ booking.route.name }} ({{ booking.route.total_km }} KM)
          {% else %}
            -
          {% endif %}
        </div>
        <div class="col-md-4">
          <strong>Lorry</strong><br>
          {% if booking.lorry %}
            {{ booking.lorry.capacity }} Ton · {{ booking.lorry.number_of_wheels }} wheels · {{ booking.lorry.carrier_size }}
          {% else %}
            -
          {% endif %}
        </div>
      </div>

      {% if booking.remarks %}
        <div class="row mt-2">
          <div class="col-12">
            <strong>Remarks</strong><br>
            <pre class="mb-0">{{ booking.remarks }}</pre>
          </div>
        </div>
      {% endif %}

    </div>
  </div>

  <!-- Route / authorities summary -->
  <div class="card mb-3">
    <div class="card-header bg-light">
      Route &amp; Authorities
    </div>
    <div class="card-body">

      <div class="row">
        <div class="col-md-6 mb-3">
          <h6>Loading Side (FROM)</h6>
          <hr class="my-2">
          {% set loading_auths = booking.booking_authorities|selectattr('role','equalto','LOADING')|list %}
          {% if loading_auths %}
            <ul class="list-unstyled small mb-0">
              {% for ba in loading_auths %}
                <li class="mb-1">
                  {% if ba.authority %}
                    <strong>{{ ba.authority.authority_title }}</strong>
                    <br>
                    <span class="text-muted">
                      {% if ba.authority.location %}
                        {{ ba.authority.location.name }} [{{ ba.authority.location.code }}]
                      {% else %}
                        (No location)
                      {% endif %}
                    </span>
                    {% if ba.authority.address %}
                      <br>
                      <span class="text-muted">{{ ba.authority.address }}</span>
                    {% endif %}
                  {% else %}
                    <em class="text-muted">[Missing authority record]</em>
                  {% endif %}
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="text-muted mb-0">No loading authorities recorded.</p>
          {% endif %}
        </div>

        <div class="col-md-6 mb-3">
          <h6>Unloading Side (DESTINATION)</h6>
          <hr class="my-2">
          {% set unloading_auths = booking.booking_authorities|selectattr('role','equalto','UNLOADING')|list %}
          {% if unloading_auths %}
            <ul class="list-unstyled small mb-0">
              {% for ba in unloading_auths %}
                <li class="mb-1">
                  {% if ba.authority %}
                    <strong>{{ ba.authority.authority_title }}</strong>
                    <br>
                    <span class="text-muted">
                      {% if ba.authority.location %}
                        {{ ba.authority.location.name }} [{{ ba.authority.location.code }}]
                      {% else %}
                        (No location)
                      {% endif %}
                    </span>
                    {% if ba.authority.address %}
                      <br>
                      <span class="text-muted">{{ ba.authority.address }}</span>
                    {% endif %}
                  {% else %}
                    <em class="text-muted">[Missing authority record]</em>
                  {% endif %}
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="text-muted mb-0">No unloading authorities recorded.</p>
          {% endif %}
        </div>
      </div>

    </div>
  </div>

  <!-- Editable fields (placement_date, lorry_id) -->
  <div class="card mb-3">
    <div class="card-header bg-light">
      Edit Booking (Placement Date &amp; Lorry)
    </div>
    <div class="card-body">
      {% if booking.status == 'CANCELLED' %}
        <div class="alert alert-warning mb-3">
          This booking has been cancelled. Editing is disabled.
        </div>
      {% endif %}

      <form
        method="POST"
        action="{{ url_for('admin.booking_detail',
                          booking_id=booking.id,
                          booking_scope=request.args.get('booking_scope'),
                          booking_status=request.args.get('booking_status'),
                          booking_search=request.args.get('booking_search')) }}"
      >
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

        <div class="row g-3 align-items-end">
          <div class="col-md-4">
            <label for="placementDateDetail" class="form-label form-label-sm mb-1">
              Placement Date
            </label>
            <input
              type="date"
              id="placementDateDetail"
              name="placement_date"
              class="form-control form-control-sm"
              value="{{ booking.placement_date }}"
              {% if booking.status == 'CANCELLED' %}disabled{% endif %}
            >
          </div>

          <div class="col-md-4">
            <label for="lorryDetail" class="form-label form-label-sm mb-1">
              Lorry
            </label>
            <select
              id="lorryDetail"
              name="lorry_id"
              class="form-select form-select-sm"
              {% if booking.status == 'CANCELLED' %}disabled{% endif %}
            >
              <option value="">-- Select Lorry --</option>
              {% for l in lorries %}
                <option
                  value="{{ l.id }}"
                  {% if l.id == booking.lorry_id %}selected{% endif %}
                >
                  {{ l.capacity }} Ton · {{ l.number_of_wheels }} wheels · {{ l.carrier_size }}
                </option>
              {% endfor %}
            </select>
          </div>

          <div class="col-12 text-end">
            <button type="submit" class="btn btn-primary btn-sm"
                    {% if booking.status == 'CANCELLED' %}disabled{% endif %}>
              Save Booking
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>

  {# -------------------------------------------------------------------- #}
  {# Materials (MULTI-SCOPE editor on detail page)                          #}
  {# JS serializes accordion state into a single hidden JSON field.         #}
  {# -------------------------------------------------------------------- #}

  {% set mats = booking.material_tables if booking else [] %}
  {% set mats_sorted = mats|sort(attribute='sequence_index') %}

  <div class="card mt-4">
    <div class="card-header bg-light d-flex justify-content-between align-items-center">
      <span>Materials (per scope)</span>
      <small class="text-muted">
        Each scope = Loading Authority → Unloading Authority.
      </small>
    </div>

    <div class="card-body">
      {% if booking.status == 'CANCELLED' %}
        <div class="alert alert-warning mb-3">
          This booking has been cancelled. Editing is disabled.
        </div>
      {% endif %}

      <form
        method="POST"
        action="{{ url_for('admin.booking_materials_edit', booking_id=booking.id) }}"
        id="materialEditFormDetail"
      >
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="materials_scopes_json" id="materialsScopesJSONDetail" value="">

        {% if not mats_sorted %}
          <div class="text-muted">
            No material scopes found for this booking yet.
          </div>
        {% else %}

          <div class="accordion" id="materialsScopesAccordionDetail">

            {% for m in mats_sorted %}
              {% set from_ba = m.booking_authority %}
              {% set to_ba = m.to_booking_authority %}

              {% set from_auth = from_ba.authority if from_ba else None %}
              {% set to_auth = to_ba.authority if to_ba else None %}

              {% set from_title = from_auth.authority_title if from_auth else 'Loading (Unknown)' %}
              {% set to_title = to_auth.authority_title if to_auth else 'Unloading (Unknown)' %}

              {% set from_loc = from_auth.location if from_auth else None %}
              {% set to_loc = to_auth.location if to_auth else None %}

              {% set from_loc_label = (from_loc.name ~ ' [' ~ from_loc.code ~ ']') if from_loc else '' %}
              {% set to_loc_label = (to_loc.name ~ ' [' ~ to_loc.code ~ ']') if to_loc else '' %}

              {% set scope_index = loop.index0 %}

              <div
                class="accordion-item"
                data-scope-index="{{ scope_index }}"
                data-from-authority-id="{{ from_auth.id if from_auth else '' }}"
                data-to-authority-id="{{ to_auth.id if to_auth else '' }}"
              >
                <h2 class="accordion-header" id="scopeHead{{ scope_index }}">
                  <button
                    class="accordion-button {% if not loop.first %}collapsed{% endif %}"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#scopeBody{{ scope_index }}"
                    aria-expanded="{% if loop.first %}true{% else %}false{% endif %}"
                    aria-controls="scopeBody{{ scope_index }}"
                  >
                    <div class="w-100 d-flex justify-content-between align-items-center">
                      <div>
                        <strong>{{ from_title }}</strong>
                        <span class="text-muted">→</span>
                        <strong>{{ to_title }}</strong>
                        <div class="small text-muted">
                          {{ from_loc_label }}{% if from_loc_label and to_loc_label %} → {% endif %}{{ to_loc_label }}
                        </div>
                      </div>
                      <div class="ms-3">
                        <span class="badge bg-secondary" data-role="scope-mode-badge">
                          {{ m.mode or '-' }}
                        </span>
                      </div>
                    </div>
                  </button>
                </h2>

                <div
                  id="scopeBody{{ scope_index }}"
                  class="accordion-collapse collapse {% if loop.first %}show{% endif %}"
                  aria-labelledby="scopeHead{{ scope_index }}"
                  data-bs-parent="#materialsScopesAccordionDetail"
                >
                  <div class="accordion-body">

                    <div class="table-responsive">
                      <table class="table table-sm table-bordered align-middle mb-0">
                        <thead class="table-secondary">
                          <tr class="text-center">
                            <th style="width: 40px;">Sl.</th>
                            <th>Description</th>
                            <th style="width: 100px;">Unit</th>
                            <th style="width: 110px;">Qty</th>
                            <th style="width: 140px;">Rate</th>
                            <th style="width: 170px;">Amount</th>
                            <th style="width: 50px;"></th>
                          </tr>

                          {# Optional helper row: remove if you dislike it #}
                          <tr class="text-muted small">
                            <th></th>
                            <th colspan="2">LUMPSUM: use Description + Qty (Unit optional)</th>
                            <th class="text-center">Qty</th>
                            <th class="text-center">Rate (ITEM only)</th>
                            <th class="text-center">Amount (ITEM only)</th>
                            <th></th>
                          </tr>
                        </thead>

                        <tbody data-role="scope-lines">
                          {% if m.lines and (m.lines|length) > 0 %}
                            {% for line in m.lines|sort(attribute='sequence_index') %}
                              <tr data-role="scope-line">
                                <td class="text-center align-middle">{{ loop.index }}</td>
                                <td>
                                  <input
                                    type="text"
                                    class="form-control form-control-sm scope-desc"
                                    value="{{ line.description }}"
                                    required
                                    {% if booking.status == 'CANCELLED' %}disabled{% endif %}
                                  >
                                </td>
                                <td>
                                  <input
                                    type="text"
                                    class="form-control form-control-sm scope-unit"
                                    value="{{ line.unit or '' }}"
                                    {% if booking.status == 'CANCELLED' %}disabled{% endif %}
                                  >
                                </td>
                                <td>
                                  <input
                                    type="number"
                                    class="form-control form-control-sm scope-qty"
                                    step="0.001"
                                    min="0"
                                    value="{% if line.quantity is not none %}{{ '%.3f'|format(line.quantity) }}{% endif %}"
                                    {% if booking.status == 'CANCELLED' %}disabled{% endif %}
                                  >
                                </td>
                                <td>
                                  <input
                                    type="number"
                                    class="form-control form-control-sm scope-rate"
                                    step="0.01"
                                    min="0"
                                    value="{% if line.rate is not none %}{{ '%.2f'|format(line.rate) }}{% endif %}"
                                    {% if booking.status == 'CANCELLED' %}disabled{% endif %}
                                  >
                                </td>
                                <td>
                                  <input
                                    type="number"
                                    class="form-control form-control-sm scope-amount"
                                    step="0.01"
                                    min="0"
                                    value="{% if line.amount is not none %}{{ '%.2f'|format(line.amount) }}{% endif %}"
                                    {% if booking.status == 'CANCELLED' %}disabled{% endif %}
                                  >
                                </td>
                                <td class="text-center">
                                  <button
                                    type="button"
                                    class="btn btn-sm btn-outline-danger"
                                    data-role="remove-scope-line"
                                    {% if booking.status == 'CANCELLED' %}disabled{% endif %}
                                  >
                                    ×
                                  </button>
                                </td>
                              </tr>
                            {% endfor %}
                          {% else %}
                            <tr data-role="scope-line">
                              <td class="text-center align-middle">1</td>
                              <td>
                                <input
                                  type="text"
                                  class="form-control form-control-sm scope-desc"
                                  value=""
                                  required
                                  {% if booking.status == 'CANCELLED' %}disabled{% endif %}
                                >
                              </td>
                              <td>
                                <input
                                  type="text"
                                  class="form-control form-control-sm scope-unit"
                                  value=""
                                  {% if booking.status == 'CANCELLED' %}disabled{% endif %}
                                >
                              </td>
                              <td>
                                <input
                                  type="number"
                                  class="form-control form-control-sm scope-qty"
                                  step="0.001"
                                  min="0"
                                  {% if booking.status == 'CANCELLED' %}disabled{% endif %}
                                >
                              </td>
                              <td>
                                <input
                                  type="number"
                                  class="form-control form-control-sm scope-rate"
                                  step="0.01"
                                  min="0"
                                  {% if booking.status == 'CANCELLED' %}disabled{% endif %}
                                >
                              </td>
                              <td>
                                <input
                                  type="number"
                                  class="form-control form-control-sm scope-amount"
                                  step="0.01"
                                  min="0"
                                  {% if booking.status == 'CANCELLED' %}disabled{% endif %}
                                >
                              </td>
                              <td class="text-center">
                                <button
                                  type="button"
                                  class="btn btn-sm btn-outline-danger"
                                  data-role="remove-scope-line"
                                  {% if booking.status == 'CANCELLED' %}disabled{% endif %}
                                >
                                  ×
                                </button>
                              </td>
                            </tr>
                          {% endif %}
                        </tbody>
                      </table>
                    </div>

                    <!-- Totals moved BELOW the table (better reading flow) -->
                    <div class="row g-3 align-items-end mt-3">
                      <div class="col-md-4">
                        <label class="form-label form-label-sm mb-1">Mode</label>
                        <select
                          class="form-select form-select-sm"
                          data-role="scope-mode"
                          {% if booking.status == 'CANCELLED' %}disabled{% endif %}
                        >
                          <option value="">(Select)</option>
                          <option value="ITEM" {% if m.mode == 'ITEM' %}selected{% endif %}>Item-wise (ITEM)</option>
                          <option value="LUMPSUM" {% if m.mode == 'LUMPSUM' %}selected{% endif %}>Lumpsum</option>
                          <option value="ATTACHED" {% if m.mode == 'ATTACHED' %}selected{% endif %}>Attached</option>
                        </select>
                      </div>

                      <div class="col-md-4">
                        <label class="form-label form-label-sm mb-1">Total Amount</label>
                        <div class="input-group input-group-sm">
                          <span class="input-group-text">₹</span>
                          <input
                            type="number"
                            class="form-control scope-total-amount"
                            step="0.01"
                            min="0"
                            value="{% if m.total_amount is not none %}{{ '%.2f'|format(m.total_amount) }}{% endif %}"
                            placeholder="Total / Lumpsum / Attached"
                            {% if booking.status == 'CANCELLED' %}disabled{% endif %}
                          >
                        </div>
                      </div>

                      <div class="col-md-4">
                        <label class="form-label form-label-sm mb-1">Total Quantity (LUMPSUM)</label>
                        <div class="input-group input-group-sm">
                          <input
                            type="number"
                            class="form-control scope-total-qty"
                            step="0.001"
                            min="0"
                            value="{% if m.total_quantity is not none %}{{ '%.3f'|format(m.total_quantity) }}{% endif %}"
                            placeholder="e.g. 25.500"
                            {% if booking.status == 'CANCELLED' %}disabled{% endif %}
                          >
                          <input
                            type="text"
                            class="form-control scope-total-unit"
                            value="{{ m.total_quantity_unit or '' }}"
                            placeholder="Unit (e.g. MT)"
                            {% if booking.status == 'CANCELLED' %}disabled{% endif %}
                          >
                        </div>
                      </div>
                    </div>

                    <div class="mt-3 d-flex justify-content-end gap-2">
                      <button
                        type="button"
                        class="btn btn-sm btn-outline-primary"
                        data-role="add-scope-row"
                        {% if booking.status == 'CANCELLED' %}disabled{% endif %}
                      >
                        Add Row
                      </button>
                    </div>

                  </div>
                </div>
              </div>
            {% endfor %}

          </div>

          <div class="mt-3 d-flex justify-content-end gap-2">
            <a
              href="{{ url_for('admin.booking_detail', booking_id=booking.id) }}"
              class="btn btn-sm btn-outline-secondary"
            >
              Cancel
            </a>

            <button
              type="submit"
              class="btn btn-sm btn-success"
              {% if booking.status == 'CANCELLED' %}disabled{% endif %}
            >
              Save Materials (All Scopes)
            </button>
          </div>

          <div class="mt-2 small text-muted">
            Notes:
            <ul class="mb-0">
              <li>ITEM: amount is computed from Qty × Rate on save (and UI keeps it locked).</li>
              <li>LUMPSUM: use either header Total Quantity or per-line quantities (not both).</li>
              <li>ATTACHED: use only Total Amount; lines will be canonicalized.</li>
            </ul>
          </div>

        {% endif %}
      </form>
    </div>
  </div>

</div>

{% endblock %}

{% block extra_scripts %}
  {{ super() }}
  <script src="{{ url_for('static', filename='js/booking_detail_materials.js') }}"></script>
{% endblock %}
